<html>

	<head>
		<title>Protocol Generator</title>
		<script type='text/javascript' src='knockout-2.1.0.js'></script>


	</head>

	<body>

		Protocol Generator

		<div>
			<select data-bind="options: availableLanguages, value: selectedLanguage"></select>
			<br/>
			<input type="textfield" data-bind="value: modelName"></input>
			<br/>
			<textarea rows="20" cols="50" data-bind="value: json"></textarea>
			<br/>
			<input type="button" value="Generate" data-bind="click: generate"></input>
		</div>

		<!-- ko if: selectedLanguage() == 'iOS' -->
		<div style="margin: 10px; padding: 10px; background-color: #EAEAEA;">

			<div>
				#import "<span data-bind="text: modelName">&nbsp;</span>.h"
			</div>

			<br/>

			<div>
				@interface <span data-bind="text: modelName">&nbsp;</span> : ProtocolObject
			</div>

			<br/>

			<!-- ko foreach: jsonObject -->

			<div data-bind="text: property()"></div>

			<!-- /ko -->

			<br/>

			<div>
				@end
			</div>

		</div>

		<div style="margin: 10px; padding: 10px; background-color: #EAEAEA;">

			<div>
				#import "<span data-bind="text: modelName">&nbsp;</span>.h"
			</div>

			<br/>

			<div>
				@implementation <span data-bind="text: modelName">&nbsp;</span>
			</div>

			<br/>

			<!-- ko foreach: jsonObject -->

			<div data-bind="text: synthesize()"></div>

			<!-- /ko -->

			<br/>

			- (NSDictionary *)mapKeysToProperties {
			<br/>
			return [[NSDictionary alloc] initWithObjectsAndKeys:
			<br/>

			<!-- ko foreach: jsonObject -->
			<div data-bind="text: mapKeysToProperties()"></div>
			<!-- /ko -->

			<br/>
			nil];
			<br/>
			}
			<br/>

			<div>
				@end
			</div>

		</div>

		<!-- /ko -->

		<!-- ko if: selectedLanguage() == 'Android' -->
		<div style="margin: 10px; padding: 10px; background-color: #EAEAEA;">

			<div>
				public class <span data-bind="text: modelName">&nbsp;</span> extends ProtocolModel {
			</div>

			<br/>

			<!-- ko foreach: jsonObject -->

			<div data-bind="text: classVariables()"></div>

			<!-- /ko -->

			<br/>

			<div>
				public <span data-bind="text: modelName">&nbsp;</span>() {
				<br/>
					super();
					<br/>
				}
				<br/>

				<br/>
				public <span data-bind="text: modelName">&nbsp;</span>(JSONObject jsonObject) {
				<br/>
					super(jsonObject);
					<br/>
				}
				<br/>
			</div>

			<br/>

			<div>
				@Override
				<br/>
				public void mapToClass(String key, Object value) {
				<br/>

					<!-- ko foreach: jsonObject -->

					<span data-bind="text: ($index() == 0 ? 'if ' : ' else if ')"></span> (key.equals("<span data-bind="text: name"></span>")) {
					<br/>
						<span data-bind="text: setClassVariable()"></span>
						<br/>
					}

					<!-- /ko -->
					<br/>
				}
				<br/>
			</div>

			<div>
				<br/>
				}
			</div>

		</div>

		<!-- /ko -->

	</body>

	<script type="text/javascript">

		(function() {

		 	String.prototype.toProperCase = function () {
				return this.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
			};

			String.prototype.toCamel = function () {
				var camel = this.replace(/(\_[a-z])/g, function($1){return $1.toUpperCase().replace('_','');});
				camel = camel.replace(/(\-[a-z])/g, function($1){return $1.toUpperCase().replace('-','');});
				camel = camel.replace(/(\ [a-z])/g, function($1){return $1.toUpperCase().replace(' ','');});

				camel = camel.charAt(0).toLowerCase() + camel.slice(1);

				return camel;
			};

			function Attribute(name, value) {

				this.name = name;
				this.value = value;

				this.varName = function() {
					return this.name.toCamel();
				};

				this.property = function() {

					var varName = this.varName();

					if (typeof(value) == "string") {
						return "@property (nonatomic, strong) NSString *" + varName + ";";	
					} else if (typeof(value) == "number") {
						return "@property (nonatomic, strong) NSNumber *" + varName + ";";	
					} else if (typeof(value) == "boolean") {
						return "@property (nonatomic, assign) BOOL " + varName + ";";	
					}

				};

				this.synthesize = function() {

					var varName = this.varName();

					return "@synthesize " + varName + " = _" + varName + ";"; 

				};

				this.mapKeysToProperties = function() {
					return "@\"" + this.varName()  + "\",@\"" + this.name  + "\",";
				}

				this.classVariables = function() {

					var varName = this.varName();

					if (typeof(value) == "string") {
						return "private String " + varName + ";";	
					} else if (typeof(value) == "number") {

						if (value % 1 === 0) {
							return "private int " + varName + ";"
						} else {
							return "private double " + varName + ";"
						}

					} else if (typeof(value) == "boolean") {
						return "private boolean " + varName + ";";	
					}

				};

				this.setClassVariable = function() {

					var varName = this.varName();

					if (typeof(value) == "string") {
						return "this." + varName + " = (String)value;";	
					} else if (typeof(value) == "number") {

						if (value % 1 === 0) {
							return "this." + varName + " = (Integer)value;";	
						} else {
							return "this." + varName + " = Double.parseDouble(value.toString());";	
						}

					} else if (typeof(value) == "boolean") {
						return "this." + varName + " = (Boolean)value;";		
					}

				};

			}

			function ViewModel() {

				this.availableLanguages = ko.observableArray(['iOS', 'Android']);
				this.selectedLanguage = ko.observable();

				this.modelName = ko.observable("ModelName");

				this.json = ko.observable('{"some_string":"Test string", "number":5,"bool_value":true}');
				this.jsonObject = ko.observableArray();

				this.generate = function() {
					var jsonEvaled = eval('(' + this.json() + ')');
					if (jsonEvaled == null) {
						return null;
					}

					var attributes = [];
					for (var key in jsonEvaled) {
						var attribute = new Attribute(key, jsonEvaled[key]);
						attributes.push(attribute);
					}

					this.jsonObject(attributes);
				};

				this.generate();

			}

			// Activates knockout.js
			var viewModel = new ViewModel();
			ko.applyBindings(viewModel);

			viewModel.generate();
		})();

	</script>

</html>
